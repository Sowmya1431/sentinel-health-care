<!-- templates/upload_video.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Upload Video | Sentinel Health</title>

  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --accent:#5a4fd6;
      --accent-2:#6f6ef8;
      --muted:#7b8090;
      --border:#e8ebf3;
      --radius:14px;
      --shadow: 0 8px 30px rgba(21,24,40,0.04);
    }
    * { box-sizing: border-box; }
    html,body{height:100%;margin:0;font-family:Inter, "Roboto", system-ui, "Segoe UI", Arial;background:var(--bg);color:#111}
    a{color:inherit;text-decoration:none}

    .sidebar { width: 260px; height: 100vh; background: var(--card); position: fixed; left: 0; top: 0; padding: 28px 18px; border-right: 1px solid #eceff6; display: flex; flex-direction: column; align-items: flex-start; gap: 18px; box-shadow: 3px 0 15px rgba(0,0,0,0.03); }
    .logo-container { display:flex; align-items:center; gap:12px; width:100% }
    .logo-container img{ width:44px; height:44px; border-radius:10px; object-fit:cover }
    .logo-container h1{ font-size:18px; color:var(--accent); margin:0; font-weight:800 }

    .nav-list { width:100%; margin-top:8px; display:flex; flex-direction:column; gap:8px; }
    .nav-item { width:100%; padding:12px 16px; display:block; color:#333; font-size:15px; border-radius:12px; transition: all .16s ease; font-weight:700; background:transparent; cursor:pointer; }
    .nav-item:hover { background: rgba(90,79,214,0.06); color:var(--accent); transform: translateY(-2px) }
    .nav-item.active { background: linear-gradient(90deg, rgba(90,79,214,0.06), rgba(90,79,214,0.02)); color:var(--accent); box-shadow: 0 6px 18px rgba(75,44,224,0.04) }

    .main-content { margin-left: 300px; padding: 36px; display: flex; gap: 32px; align-items:flex-start; min-height:100vh; }
    .upload-card { background: var(--card); flex: 1 1 65%; padding: 26px; border-radius: 14px; box-shadow: var(--shadow); min-width: 320px; border:1px solid var(--border); }
    .title { font-size:26px; font-weight:800; margin:0 0 12px 0 }
    .upload-wrap { display:flex; flex-direction:column; gap:12px; align-items:stretch }

    .drop { border: 2px dashed var(--border); padding: 28px; border-radius: 12px; text-align: center; color: var(--muted); cursor: pointer; transition: 0.22s; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; min-height:220px; background: #fff; position: relative; overflow: visible; }
    .drop.dragover { border-color: var(--accent); box-shadow: 0 18px 60px rgba(90,79,214,0.06); background: #faf8ff; transform: translateY(-2px); }
    .drop svg { opacity: 0.95 }
    .drop .d-title { font-weight:800; color:#101217; font-size:16px }
    .drop .desc { color:var(--muted); font-size:14px }
    .file-name { margin-top:6px; color:#333; font-weight:700; font-size:14px }

    .player-overlay { width: calc(100% - 20px); border-radius: 10px; padding:12px; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.96)); box-shadow: 0 8px 30px rgba(20,24,40,0.05); display:flex; flex-direction:column; gap:10px; align-items:stretch; position: relative; margin-top:8px; }
    .player-toolbar { display:flex;justify-content:space-between;align-items:center;gap:12px }
    .player-toolbar .meta { color:var(--muted); font-size:13px }
    .player-title { font-weight:800; color:#0f1221; font-size:15px; word-break:break-all; text-align:center }
    .player-actions { position:absolute; right:12px; top:12px; display:flex; gap:8px; z-index:5; }
    .action-btn { background:#fff; border-radius:12px; padding:8px 10px; font-weight:700; box-shadow:0 6px 20px rgba(30,35,60,0.06); border:1px solid var(--border); cursor:pointer; }
    .stream-wrap { width:100%; border-radius:8px; overflow:hidden; background:#000; display:flex; justify-content:center; align-items:center; min-height:160px }
    .stream { width:100%; height:auto; display:block; max-height:420px; object-fit:contain; }

    .controls { display:flex; gap:12px; align-items:center; margin-top:8px }
    .btn-upload, .btn { background: var(--accent); color: white; padding: 14px; border-radius: 10px; border: none; font-size: 15px; cursor: pointer; font-weight:800; flex:1; }
    .btn.secondary { background: #fff; color: var(--accent); border:1px solid var(--border); flex: 0 0 auto; padding: 10px 14px; }

    .progress { height:10px; background:#f4f6fb; border-radius:999px; overflow:hidden; margin-top:12px }
    .progress > i { display:block; height:100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); width:0% }

    .alerts-panel { flex: 0 0 340px; background: var(--card); padding: 22px; border-radius: 14px; box-shadow: var(--shadow); min-width: 260px; align-self: start; border:1px solid var(--border); height: calc(100vh - 80px); overflow:hidden; display:flex; flex-direction:column; gap:14px; }
    .alerts-panel h3 { margin:0 0 0 0; font-size:18px }
    .alerts-list { overflow:auto; padding-right:8px; display:flex; flex-direction:column; gap:10px; }
    .alert-card { background:#fff; padding:12px; border-radius:10px; border:1px solid #f0f2f6; box-shadow: 0 4px 12px rgba(12,16,30,0.03); color:#222; font-size:13px; }
    .recent-uploads { margin-top:6px; color:var(--muted); font-size:14px; overflow:auto; max-height:180px; padding-right:6px }
    .recent-item { padding:10px 12px; background:#fff; border-radius:10px; border:1px solid #f0f2f6; margin-bottom:8px; font-size:13px; color:#222; }
    @media (max-width: 980px) { .sidebar { position:relative; width:100%; height:auto; flex-direction:row; padding:14px; justify-content:space-between } .main-content { margin-left: 0; padding:20px; flex-direction:column } .alerts-panel { width:100%; height:auto; order:3 } .upload-card { order:1 } }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" role="navigation" aria-label="Main navigation">
        <div class="logo-container">
            <img src="/static/images/logo1.png" alt="logo" />
            <h1>Sentinel Health</h1>
        </div>

        <div class="nav-list" role="menu" aria-label="Sidebar links">
            <div class="nav-item"><a href="/about">About</a></div>
            <div class="nav-item"><a href="/upload">Upload Video</a></div>
            <div class="nav-item"><a href="/admin">Admin Panel</a></div>
            <div class="nav-item"><a href="/logout">Logout</a></div>

        </div>
    </div>

  <!-- Main Content -->
  <div class="main-content" role="main">
    <!-- Upload Card -->
    <div class="upload-card" aria-labelledby="pageTitle">
      <h2 id="pageTitle" class="title">Upload Video for Analysis</h2>

      <form id="uploadForm" class="upload-wrap" onsubmit="return false;" aria-describedby="uploadHint">
        <label id="dropArea" class="drop" for="videoInput" role="button" aria-label="Drop video file here" tabindex="0">
          <div id="dropInner">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v12" stroke="#9aa0b4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 7l4-4 4 4" stroke="#9aa0b4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M21 15v2a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-2" stroke="#9aa0b4" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>

            <div class="d-title">Drag & drop a video here</div>
            <div id="uploadHint" class="desc">or click to browse · Max 500 MB · mp4, avi, mov, mkv</div>
            <div class="file-name" id="fileName" aria-live="polite"></div>
          </div>

          <input id="videoInput" type="file" name="video" accept="video/*" />
        </label>

        <div class="controls">
          <button type="button" id="processBtn" class="btn-upload" disabled>Process Video</button>
          <button type="button" id="chooseBtn" class="btn secondary">Choose File</button>
        </div>

        <div class="progress" id="uploadProgress" aria-hidden="true" style="display:none">
          <i id="uploadBar" style="width:0%"></i>
        </div>
      </form>
    </div>

    <!-- Alerts / Right panel -->
    <div class="alerts-panel" aria-labelledby="alertsTitle">
      <h3 id="alertsTitle">Recent Alerts</h3>

      <div class="alerts-list" id="alertList">
        <div class="alert-card">No alerts yet</div>
      </div>

      <hr style="margin:8px 0; border:none; border-top:1px solid #f0f2f6">

      <h3 style="margin:0">Recent Uploads</h3>
      <div class="recent-uploads" id="recentList">
        <div style="color:var(--muted); padding:6px 0">No uploads yet.</div>
      </div>
    </div>
  </div>

  <script>
    // Templates use Flask url_for, so these will be rendered server-side:
    const UPLOAD_URL = "{{ url_for('upload_page') }}";
    // stream_video returns MJPEG frames from detector (useful if detector.video_frame_generator is available)
    const STREAM_URL_TEMPLATE = "{{ url_for('stream_video', filename='__FILENAME__') }}";
    // fallback direct file URL (served by uploaded_file)
    const DOWNLOAD_URL_TEMPLATE = "{{ url_for('uploaded_file', filename='__FILENAME__') }}";

    const drop = document.getElementById('dropArea');
    const dropInner = document.getElementById('dropInner');
    const inp = document.getElementById('videoInput');
    const fileNameEl = document.getElementById('fileName');
    const chooseBtn = document.getElementById('chooseBtn');
    const processBtn = document.getElementById('processBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadBar = document.getElementById('uploadBar');
    const recentList = document.getElementById('recentList');
    const alertList = document.getElementById('alertList');

    function log(...a){ console.log('[ui]', ...a); }

    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('dragover'); }));
    ['dragleave','dragend','drop'].forEach(ev => drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('dragover'); }));

    drop.addEventListener('drop', e => {
      const dt = e.dataTransfer;
      if (dt && dt.files && dt.files.length) {
        inp.files = dt.files;
        showFile(dt.files[0]);
      }
    });

    drop.addEventListener('click', () => inp.click());
    chooseBtn.addEventListener('click', () => inp.click());
    inp.addEventListener('change', () => { if (inp.files && inp.files[0]) showFile(inp.files[0]); });

    function showFile(f) {
      const mb = Math.round(f.size/1024/1024*10)/10;
      fileNameEl.textContent = `${f.name} · ${mb} MB`;
      processBtn.disabled = false;
      log('selected', f.name, mb+'MB');
    }

    processBtn.addEventListener('click', () => {
      if (!inp.files || !inp.files[0]) { alert('Please choose a video file first.'); return; }
      const file = inp.files[0];

      const MAX_MB = 500;
      if ((file.size/1024/1024) > MAX_MB) { alert('File too large. Max 500MB'); return; }

      const fd = new FormData();
      fd.append('video', file);

      uploadProgress.style.display = 'block';
      uploadBar.style.width = '0%';
      processBtn.disabled = true;
      processBtn.textContent = 'Uploading...';

      const xhr = new XMLHttpRequest();
      xhr.open('POST', UPLOAD_URL, true);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          uploadBar.style.width = pct + '%';
        }
      };

      xhr.onload = () => {
        uploadBar.style.width = '100%';
        processBtn.disabled = false;
        processBtn.textContent = 'Process Video';
        log('upload completed', xhr.status, xhr.responseText);

        let res = null;
        try { res = xhr.responseText ? JSON.parse(xhr.responseText) : null; } catch (err) {
          console.error('non-JSON response', xhr.responseText);
          alert('Server returned unexpected response. See console for details.');
          return;
        }

        if (xhr.status >= 200 && xhr.status < 300) {
          if (res && res.success && res.filename) {
            embedPlayerInDrop(res.filename);
            prependRecent(res.filename);
            addAlert(`Uploaded ${res.filename}`);
          } else {
            const msg = (res && (res.message||res.error)) ? (res.message||res.error) : 'Upload OK but server response missing filename.';
            alert(msg);
            console.warn('unexpected response', res);
          }
        } else {
          const msg = (res && (res.message||res.error)) ? (res.message||res.error) : `Upload failed: ${xhr.status}`;
          alert(msg);
          console.error('upload failed', res);
        }
      };

      xhr.onerror = () => {
        alert('Upload failed (network). Check console.');
        console.error('xhr error');
        processBtn.disabled = false;
        uploadProgress.style.display = 'none';
      };

      try { xhr.send(fd); } catch (ex) { console.error('send exception', ex); alert('Upload failed (exception). See console.'); processBtn.disabled=false; uploadProgress.style.display='none'; }
    });

    /* embed player (tries MJPEG detector stream first; falls back to direct file link) */
    function embedPlayerInDrop(filename) {
      // For MJPEG stream (detector): STREAM_URL_TEMPLATE -> stream_video endpoint
      // For direct playback: DOWNLOAD_URL_TEMPLATE -> uploaded_file endpoint
      const streamUrl = STREAM_URL_TEMPLATE.replace('__FILENAME__', encodeURIComponent(filename));
      const downloadUrl = DOWNLOAD_URL_TEMPLATE.replace('__FILENAME__', encodeURIComponent(filename));

      // remove existing overlay if present
      const prev = drop.querySelector('.player-overlay');
      if (prev) prev.remove();
      if (dropInner) dropInner.style.display = 'none';

      const isVideo = /\.(mp4|webm|ogg|mkv|mov)$/i.test(filename);
      const overlay = document.createElement('div');
      overlay.className = 'player-overlay';

      // If you want to stream detector output (MJPEG), keep the <img src=streamUrl>.
      // If you prefer playing the saved video file directly, the <video> uses downloadUrl.
      overlay.innerHTML = `
        <div class="player-actions" aria-hidden="false">
          <button class="action-btn" id="stopStreamBtn">Stop</button>
          <a class="action-btn" id="downloadLink" href="${downloadUrl}" target="_blank" rel="noopener">Download</a>
        </div>
        <div class="player-toolbar">
          <div style="flex:1; display:flex; justify-content:center;">
            <div class="player-title">${filename}</div>
          </div>
        </div>
        <div class="stream-wrap">
          <!-- Try detector MJPEG stream first (frame updates) -->
          <img id="streamImg" class="stream" src="${streamUrl}" alt="Detector stream" onerror="this.style.display='none'"/>
          <!-- Fallback video element (hidden initially) -->
          <video id="streamVideo" class="stream" src="${downloadUrl}" controls style="display:none" playsinline></video>
        </div>
      `;

      drop.appendChild(overlay);

      document.getElementById('stopStreamBtn').addEventListener('click', stopEmbeddedPlayer);

      // If MJPEG image fails to load (server doesn't provide MJPEG for this file),
      // show the video element as a fallback.
      const img = document.getElementById('streamImg');
      const vid = document.getElementById('streamVideo');
      img.addEventListener('error', () => {
        console.warn('MJPEG stream failed — switching to video playback');
        img.style.display = 'none';
        vid.style.display = 'block';
        vid.play().catch(e => console.warn('video play blocked', e));
      });

      // If image loads, keep it (detector frames will appear). Some browsers block autoplay on video.
      img.addEventListener('load', () => {
        // keep the img visible; hide the video
        vid.style.display = 'none';
      });
    }

    function stopEmbeddedPlayer() {
      const overlay = drop.querySelector('.player-overlay');
      if (overlay) overlay.remove();
      if (dropInner) dropInner.style.display = '';
      inp.value = '';
      fileNameEl.textContent = '';
      processBtn.disabled = true;
      uploadProgress.style.display = 'none';
    }

    function prependRecent(filename) {
      const entry = document.createElement('div');
      entry.className = 'recent-item';
      entry.textContent = `${filename} · ${new Date().toLocaleString()}`;
      if (recentList.children.length === 1 && recentList.children[0].textContent.trim().startsWith('No uploads')) {
        recentList.innerHTML = '';
      }
      recentList.insertBefore(entry, recentList.firstChild);
    }

    function addAlert(msg) {
      const node = document.createElement('div');
      node.className = 'alert-card';
      node.textContent = `${new Date().toLocaleString()} — ${msg}`;
      const first = alertList.querySelector('.alert-card');
      if (first && first.textContent.includes('No alerts yet')) first.remove();
      alertList.insertBefore(node, alertList.firstChild);
    }

    // accessibility: space/enter opens file chooser
    drop.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        inp.click();
      }
    });
  </script>
</body>
</html>
m